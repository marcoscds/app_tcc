name: Build APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      # 1Ô∏è‚É£ Pega o c√≥digo do repo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Cache do Buildozer (opcional, mas altamente recomendado)
      # Isso acelera builds subsequentes, pois o NDK/SDK j√° estar√£o baixados.
      - name: Cache Buildozer
        uses: actions/cache@v3
        with:
          path: |
            ~/.buildozer
            .buildozer
          key: buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-

      # 3Ô∏è‚É£ Build e Limpeza do Cache (A√á√ÉO CENTRAL)
      # Esta a√ß√£o instala o Python 3.10, Buildozer, Cython e depend√™ncias do sistema.
      - name: Run Buildozer with Clean and Debug
        uses: ArtemSBulgakov/buildozer-action@v1
        id: buildozer
        with:
          python-version: 3.10
          # üö® Comando de Limpeza (clean) e Build (debug) üö®
          command: buildozer android clean; buildozer android debug

      # 4Ô∏è‚É£ Upload do Log de Build (√ötil para debugar)
      # Usa a sa√≠da (output) da a√ß√£o Buildozer
      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ${{ steps.buildozer.outputs.log_file }} # O nome do log √© fornecido pela a√ß√£o
          
      # 5Ô∏è‚É£ Upload do APK gerado
      # Usa o nome do arquivo de sa√≠da (filename) fornecido pela a√ß√£o
      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: ${{ steps.buildozer.outputs.filename }} # O nome do arquivo √© fornecido pela a√ß√£o
          if-no-files-found: error
